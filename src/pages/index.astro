---
import "./style.scss";
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile</title>
  </head>
  <body>
    <header class="page-header">
      <h1>SMS Split Preview</h1>
    </header>
    <main class="app">
      <section class="pane pane-main">
        <div class="controls">
          <label class="field">
            <textarea id="messageInput" rows="12" placeholder="Type your SMS here..."></textarea>
          </label>
        </div>
      </section>

      <section class="pane pane-main">
        <div class="preview-wrap">
          <div id="preview" class="preview" aria-live="polite"></div>
          <div id="stats" class="stats"></div>
        </div>
      </section>

      <section class="pane pane-full">
        <header class="pane-header">
          <h2>Settings</h2>
          <p>
            UCS-2 mode (Taiwan/Chinese). Emoji count as 2 code units. When concatenated, each segment loses 3 units.
          </p>
        </header>
        <div class="controls controls-inline">
          <label class="field">
            <span>Single SMS limit (UCS-2 units)</span>
            <div class="input-row">
              <input id="limitInput" type="number" min="1" value="70" />
              <button id="limitReset" type="button">Reset</button>
            </div>
          </label>
          <label class="field toggle-field">
            <span>Segment display</span>
            <div class="toggle-row">
              <button id="segmentInlineBtn" type="button" class="pill is-active">Inline</button>
              <button id="segmentBlockBtn" type="button" class="pill">Block</button>
            </div>
          </label>
        </div>
      </section>

      <div class="app-meta">
        <footer class="app-footer">
          Made by fatweeb... with tremendous help from Codex
        </footer>
        <a class="repo-link" href="https://github.com/AbsoluteFatWeeb/sms-split-preview-tool" target="_blank" rel="noreferrer noopener">
          <svg class="repo-icon" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
            <path
              fill="currentColor"
              d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.5-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82a7.55 7.55 0 0 1 4 0c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.19 0 .21.15.46.55.38A8.01 8.01 0 0 0 16 8c0-4.42-3.58-8-8-8z"
            ></path>
          </svg>
          Source
        </a>
      </div>
    </main>
  </body>
</html>

<script>
  import { default as _ } from "lodash";

  const limitInput = document.getElementById("limitInput");
  const limitReset = document.getElementById("limitReset");
  const segmentInlineBtn = document.getElementById("segmentInlineBtn");
  const segmentBlockBtn = document.getElementById("segmentBlockBtn");
  const messageInput = document.getElementById("messageInput");
  const preview = document.getElementById("preview");
  const stats = document.getElementById("stats");

  const segmentColors = ["segment-1", "segment-2", "segment-3", "segment-4", "segment-5", "segment-6"];

  function countUcs2Units(text) {
    return text.length;
  }

  function splitUcs2(text, limit) {
    const parts = [];
    let i = 0;

    while (i < text.length) {
      let end = Math.min(i + limit, text.length);

      // Avoid splitting surrogate pairs (emoji, non-BMP)
      const prev = text.charCodeAt(end - 1);
      const next = text.charCodeAt(end);
      const isHigh = prev >= 0xd800 && prev <= 0xdbff;
      const isLow = next >= 0xdc00 && next <= 0xdfff;
      if (end < text.length && isHigh && isLow) {
        end -= 1;
      }

      parts.push(text.slice(i, end));
      i = end;
    }

    return parts;
  }

  function buildSegments(text, singleLimit) {
    const units = countUcs2Units(text);
    const concatLimit = Math.max(singleLimit - 3, 1);
    const isConcatenated = units > singleLimit;
    const limit = isConcatenated ? concatLimit : singleLimit;
    const parts = splitUcs2(text, limit);
    return { parts, units, limit, isConcatenated };
  }

  let blockMode = false;

  function renderPreview() {
    const limit = Math.max(parseInt(limitInput.value, 10) || 70, 1);
    const message = messageInput.value;
    const { parts, units, limit: actualLimit, isConcatenated } = buildSegments(message, limit);

    preview.innerHTML = "";
    preview.classList.toggle("preview-inline", !blockMode);

    if (message.length === 0) {
      preview.textContent = "Start typing to see the split preview.";
      stats.textContent = "";
      return;
    }

    const fragment = document.createDocumentFragment();
    parts.forEach((part, index) => {
      const block = document.createElement(blockMode ? "div" : "span");
      const colorClass = segmentColors[index % segmentColors.length];
      block.className = `segment ${colorClass}`;
      block.textContent = part;
      fragment.appendChild(block);
    });
    preview.appendChild(fragment);

    const segmentCount = parts.length;
    const label = isConcatenated
      ? `Concatenated mode (${actualLimit} units/segment)`
      : `Single SMS mode (${actualLimit} units)`;
    stats.innerHTML = `
    Total units: <span class="segment-count">${units}</span> |
    Segments: <span class="segment-count">${segmentCount}</span> |
    ${label}
  `;
  }

  const debouncedRender = _.debounce(renderPreview, 500);

  limitInput.addEventListener("input", debouncedRender);
  messageInput.addEventListener("input", debouncedRender);
  segmentInlineBtn.addEventListener("click", () => {
    blockMode = false;
    segmentInlineBtn.classList.add("is-active");
    segmentBlockBtn.classList.remove("is-active");
    renderPreview();
  });

  segmentBlockBtn.addEventListener("click", () => {
    blockMode = true;
    segmentBlockBtn.classList.add("is-active");
    segmentInlineBtn.classList.remove("is-active");
    renderPreview();
  });
  limitReset.addEventListener("click", () => {
    limitInput.value = "70";
    renderPreview();
  });

  renderPreview();
</script>
